<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre NETRUNNER // SISTEMA DE EXFILTRAÇÃO HACKER (TESTNET)</title>
    
    <script src="https://unpkg.com/ethers@5.2.0/dist/ethers.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* [ ... CÓDIGO CSS COMPLETO ANTERIOR MANTIDO ... ] */
        :root {
            --cor-primaria: #00ffff; 
            --cor-acento: #ff00ff; 
            --cor-fundo: #0a0a0a; 
            --cor-fundo-painel: #1c1c1c; 
            --cor-texto: #f0f0f0;
            --cor-terminal: #00ff66; 
            
            --sombra-primaria: 0 0 5px var(--cor-primaria), 0 0 15px var(--cor-primaria);
            --sombra-acento: 0 0 5px var(--cor-acento), 0 0 15px var(--cor-acento);
            --borda-primaria: 2px solid var(--cor-primaria);
            --borda-acento: 2px solid var(--cor-acento);

            --fonte-principal: 'Montserrat', sans-serif;
            --fonte-mono: 'Roboto Mono', monospace;
        }

        body {
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            font-family: var(--fonte-principal);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: 
                radial-gradient(circle at center, rgba(0, 255, 255, 0.1) 0%, transparent 60%),
                repeating-linear-gradient(0deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 20px),
                repeating-linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 20px);
        }

        .system-panel {
            background-color: var(--cor-fundo-painel);
            border: var(--borda-primaria);
            border-radius: 4px;
            box-shadow: 0 0 10px var(--cor-primaria), inset 0 0 5px var(--cor-primaria), 0 0 25px rgba(0, 255, 255, 0.5);
            padding: 40px;
            width: 100%;
            max-width: 950px;
            box-sizing: border-box;
            animation: border-flicker 10s infinite alternate, system-startup 0.5s ease-out;
        }

        @keyframes system-startup {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes border-flicker {
            0%, 100% { box-shadow: 0 0 10px var(--cor-primaria), inset 0 0 5px var(--cor-primaria), 0 0 25px rgba(0, 255, 255, 0.5); }
            5% { box-shadow: 0 0 15px var(--cor-acento), inset 0 0 7px var(--cor-acento); }
            10% { box-shadow: var(--sombra-primaria); }
            15% { box-shadow: var(--sombra-acento); }
        }

        h1 {
            color: var(--cor-primaria);
            text-align: center;
            margin-bottom: 30px;
            text-shadow: var(--sombra-primaria);
            border-bottom: 2px dashed var(--cor-acento);
            padding-bottom: 10px;
            font-size: 2em;
            font-weight: 800;
            letter-spacing: 5px;
        }

        .status-area {
            background-color: rgba(0, 0, 0, 0.5);
            border: var(--borda-primaria);
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 30px;
            font-family: var(--fonte-mono);
            font-size: 1em;
            box-shadow: inset 0 0 10px rgba(0, 255, 102, 0.5);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .status-label {
            color: var(--cor-texto);
            font-weight: 400;
        }

        .status-value {
            color: var(--cor-terminal);
            font-weight: 600;
            text-shadow: 0 0 8px var(--cor-terminal); 
            word-break: break-all;
        }

        #connect-button {
            width: 100%;
            margin-bottom: 30px;
            background-color: var(--cor-primaria);
            color: var(--cor-fundo);
            border: var(--borda-primaria);
            font-size: 1.2em;
            font-weight: 800;
            padding: 18px 20px;
            text-transform: uppercase;
            box-shadow: var(--sombra-primaria);
            transition: all 0.2s;
            cursor: pointer;
        }

        #connect-button:hover {
            background-color: var(--cor-fundo-painel);
            color: var(--cor-primaria);
            box-shadow: 0 0 5px var(--cor-primaria), 0 0 30px var(--cor-primaria);
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .action-group {
            background-color: rgba(0, 0, 0, 0.4);
            border: var(--borda-acento);
            border-radius: 4px;
            padding: 25px;
            box-shadow: 0 0 10px var(--cor-acento), inset 0 0 5px var(--cor-acento);
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .action-group h2 {
            color: var(--cor-acento);
            text-shadow: var(--sombra-acento);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 1px dashed var(--cor-acento);
            padding-bottom: 5px;
            letter-spacing: 2px;
        }

        input {
            background-color: rgba(0, 0, 0, 0.7);
            border: var(--borda-primaria);
            color: var(--cor-terminal);
            padding: 12px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            font-family: var(--fonte-mono);
            font-size: 1em;
            text-shadow: 0 0 3px var(--cor-terminal);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--cor-acento);
            box-shadow: 0 0 10px var(--cor-acento);
        }

        .action-group button {
            width: 100%;
            background-color: var(--cor-acento);
            color: var(--cor-fundo);
            border: var(--borda-acento);
            padding: 15px 0;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: var(--sombra-acento);
            transition: all 0.2s;
            cursor: pointer;
            margin-top: 10px; 
        }
        
        #withdraw-total-button {
            /* Destaque para o novo botão de Saque Total */
            background-color: #ff3333; 
            border-color: #ff3333;
            box-shadow: 0 0 5px #ff3333, 0 0 20px #ff3333;
        }
        #withdraw-total-button:hover {
            background-color: var(--cor-fundo-painel);
            color: #ff3333;
            box-shadow: 0 0 5px #ff3333, 0 0 30px #ff3333;
        }

        .action-group button:hover {
            background-color: var(--cor-fundo-painel);
            color: var(--cor-acento);
            box-shadow: 0 0 5px var(--cor-acento), 0 0 30px var(--cor-acento);
        }

        .message {
            margin-top: 25px;
            padding: 15px;
            border-left: 5px solid;
            font-size: 1em;
            border-radius: 4px;
            font-family: var(--fonte-mono);
            box-shadow: 0 0 5px;
        }

        .message-success {
            border-color: var(--cor-primaria);
            color: var(--cor-primaria);
            background-color: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 5px var(--cor-primaria);
        }

        .message-error {
            border-color: var(--cor-acento);
            color: var(--cor-acento);
            background-color: rgba(255, 0, 255, 0.1);
            box-shadow: 0 0 5px var(--cor-acento);
        }

        @media (max-width: 768px) {
            .action-grid {
                grid-template-columns: 1fr;
            }
            .system-panel {
                padding: 20px;
            }
            h1 {
                font-size: 1.5em;
                letter-spacing: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="system-panel">
        <h1>// ARBITRUM COFRE FINANCEIRO - SISTEMA DE EXFILTRAÇÃO //</h1>
        
        <div class="status-area">
            <div class="status-item"><span class="status-label">STATUS DA CONEXÃO:</span> <span id="conexao-status" class="status-value">DESCONECTADO</span></div>
            <div class="status-item"><span class="status-label">ENDEREÇO DO USUÁRIO ATIVO:</span> <span id="user-address" class="status-value">N/A</span></div>
            <div class="status-item"><span class="status-label">OWNER (Rodrigo):</span> <span id="dono-address" class="status-value">CARREGANDO ENDEREÇO...</span></div>
            <div class="status-item"><span class="status-label">SALDO TOTAL DO CONTRATO:</span> <span id="contract-balance" class="status-value">0.0 ETH</span></div>
        </div>
        
        <button id="connect-button">[ INICIAR HANDSHAKE DE AUTORIZAÇÃO METAMASK ]</button>
        
        <div class="action-grid">
            <div class="action-group" id="deposit-section" style="display:none;">
                <h2>// TRANSAÇÃO DE ENTRADA (DEPÓSITO) //</h2>
                <input type="number" id="deposit-amount" placeholder="Valor ETH para CREDITAR (Ex: 0.1)" min="0.000001" step="any">
                <button id="deposit-button">[ EXEC: DEPÓSITO ]</button>
            </div>
            
            <div class="action-group" id="transfer-section" style="display:none;">
                <h2>// TRANSAÇÃO DE SAÍDA (TRANSFERÊNCIA) //</h2>
                <input type="text" id="transfer-recipient" placeholder="Endereço do Destinatário (0x...)">
                <input type="number" id="transfer-amount" placeholder="Valor ETH para SACAR PARCIALMENTE (Ex: 0.05)" min="0.000001" step="any">
                <button id="transfer-button">[ EXEC: TRANSFERÊNCIA PARCIAL ]</button>
                
                <button id="withdraw-total-button">[ EXEC: SAQUE TOTAL (Owner) ]</button>
            </div>
        </div>

        <div id="message-area" class="message message-success" style="display:none;" role="alert" aria-live="polite"></div>
    </div>

    <script>
        // =======================================================
        // JAVASCRIPT: CLASSE MODULARIZADA
        // =======================================================

        class NetrunnerWallet {
            constructor() {
                // --- CONFIGURAÇÕES DE BLOCKCHAIN (Arbitrum Sepolia) ---
                this.CONFIG = {
                    // *** NOVO ENDEREÇO DO CONTRATO INSERIDO AQUI ***
                    CONTRACT_ADDRESS: "0x5842fAa589c5ACb7B00D08FeA453B2B309bA4226", 
                    
                    ARBITRUM_RPC_URL: "https://arbitrum-sepolia-rpc.publicnode.com", 
                    CHAIN_ID: 421614, // Chain ID da Arbitrum Sepolia
                    // ABI DO SEU CONTRATO (Com depositar, transferirPara, dono, saldoDoContrato e sacarTudo)
                    CONTRACT_ABI: [
                        { "inputs": [], "name": "depositar", "outputs": [], "stateMutability": "payable", "type": "function" },
                        { "inputs": [{ "internalType": "address payable", "name": "destinatario", "type": "address" }, { "internalType": "uint256", "name": "valor", "type": "uint256" }], "name": "transferirPara", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
                        { "inputs": [], "name": "dono", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
                        { "inputs": [], "name": "saldoDoContrato", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
                        // FUNÇÃO SACAR TUDO
                        { "inputs": [], "name": "sacarTudo", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
                    ]
                };

                // --- VARIÁVEIS DE ESTADO ---
                this.provider = null;
                this.signer = null;
                this.contract = null;
                this.userAddress = null;
                this.contractBalanceWei = ethers.BigNumber.from(0); 

                this.bindEvents();
            }

            // ===================================
            // FUNÇÕES DE UTILIDADE E UI
            // ===================================

            updateMessage(text, isError = false) {
                const msgArea = document.getElementById('message-area');
                msgArea.textContent = text;
                msgArea.className = `message ${isError ? 'message-error' : 'message-success'}`;
                msgArea.style.display = 'block';
                setTimeout(() => { msgArea.style.display = 'none'; }, 8000); 
            }

            formatAddress(address) {
                if (!address || address === ethers.constants.AddressZero) return "N/A (Endereço Nulo)";
                return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
            }

            showActionSections(show) {
                document.getElementById('deposit-section').style.display = show ? 'block' : 'none';
                document.getElementById('transfer-section').style.display = show ? 'block' : 'none';
                document.getElementById('connect-button').style.display = show ? 'none' : 'block';
            }

            // ===================================
            // FUNÇÕES DE EVENTOS (LISTENERS)
            // ===================================

            bindEvents() {
                document.getElementById('connect-button').addEventListener('click', () => this.conectarMetaMask());
                document.getElementById('deposit-button').addEventListener('click', () => this.depositar());
                document.getElementById('transfer-button').addEventListener('click', () => this.transferir());
                document.getElementById('withdraw-total-button').addEventListener('click', () => this.sacarTotal());


                if (typeof window.ethereum !== 'undefined') {
                    window.ethereum.on('accountsChanged', (accounts) => {
                        if (accounts.length > 0) {
                            this.conectarMetaMask();
                        } else {
                            window.location.reload();
                        }
                    });
                    window.ethereum.on('chainChanged', () => window.location.reload());
                }
            }

            // ===================================
            // FUNÇÕES DE BLOCKCHAIN
            // ===================================

            async conectarMetaMask() {
                if (typeof window.ethers === 'undefined' || typeof window.ethereum === 'undefined') {
                    this.updateMessage("ERRO! MetaMask ou ethers.js não detectado.", true);
                    return;
                }

                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    this.provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                    this.signer = this.provider.getSigner();
                    this.contract = new ethers.Contract(this.CONFIG.CONTRACT_ADDRESS, this.CONFIG.CONTRACT_ABI, this.signer);
                    
                    this.userAddress = await this.signer.getAddress();
                    
                    const { chainId } = await this.provider.getNetwork();
                    if (chainId !== this.CONFIG.CHAIN_ID) {
                        this.updateMessage("AVISO CRÍTICO: Mude para a rede **Arbitrum Sepolia** (ID 421614).", true);
                    }
                    
                    document.getElementById('conexao-status').textContent = "ONLINE // Arbitrum Sepolia";
                    document.getElementById('conexao-status').style.color = 'var(--cor-terminal)';
                    document.getElementById('user-address').textContent = this.formatAddress(this.userAddress);
                    this.showActionSections(true);

                    await this.loadContractData();
                    this.updateMessage("CONEXÃO ESTABELECIDA. Sessão de gerenciamento iniciada.");

                } catch (error) {
                    console.error(error);
                    this.updateMessage(`ERRO DE CONEXÃO: ${error.message || "Falha ao conectar."}`, true);
                }
            }

            async loadContractData() {
                // Checagem de endereço já corrigida
                if (this.CONFIG.CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
                    document.getElementById('dono-address').textContent = "FALHA DE CONFIG";
                    document.getElementById('contract-balance').textContent = "FALHA DE CONFIG";
                    this.updateMessage("ERRO CRÍTICO: Por favor, substitua o `CONTRACT_ADDRESS` na linha 358 pelo seu endereço real do contrato.", true);
                    return;
                }


                let currentProvider = this.provider;
                let contractReader;

                if (!currentProvider) {
                    // Modo somente leitura (usando RPC pública)
                    try {
                         currentProvider = new ethers.providers.JsonRpcProvider(this.CONFIG.ARBITRUM_RPC_URL);
                         contractReader = new ethers.Contract(this.CONFIG.CONTRACT_ADDRESS, this.CONFIG.CONTRACT_ABI, currentProvider);
                    } catch (err) {
                        console.error("ERRO na inicialização do Provedor RPC:", err);
                        document.getElementById('dono-address').textContent = "RPC FALHA";
                        document.getElementById('contract-balance').textContent = "RPC FALHA";
                        this.updateMessage("ERRO: Falha na RPC pública. Tente conectar sua carteira.", true);
                        return;
                    }
                } else {
                    contractReader = this.contract;
                }

                try {
                    // 1. Saldo do Contrato
                    const balanceBN = await currentProvider.getBalance(this.CONFIG.CONTRACT_ADDRESS);
                    this.contractBalanceWei = balanceBN; 
                    const balanceETH = ethers.utils.formatEther(balanceBN);
                    
                    document.getElementById('contract-balance').textContent = `${balanceETH} ETH`;

                    // 2. Dono do Contrato
                    try {
                         const dono = await contractReader.dono();
                         document.getElementById('dono-address').textContent = this.formatAddress(dono);
                    } catch (donoError) {
                         document.getElementById('dono-address').textContent = "FUNÇÃO 'dono' AUSENTE";
                         console.warn("Aviso: Falha ao chamar a função 'dono'. O contrato pode não ser o esperado.");
                    }


                } catch (error) {
                    console.error("Erro CRÍTICO ao carregar dados do contrato:", error);
                    document.getElementById('dono-address').textContent = "ERRO DE LEITURA";
                    document.getElementById('contract-balance').textContent = "ERRO DE LEITURA";
                    this.updateMessage(`ERRO CRÍTICO: O endereço do contrato (${this.CONFIG.CONTRACT_ADDRESS.substring(0, 10)}...) ou ABI pode estar incorreto.`, true);
                }
            }
            
            async depositar() {
                 if (!this.signer) {
                     this.updateMessage("ERRO: Conecte sua carteira primeiro.", true);
                     return;
                }

                const amountInput = document.getElementById('deposit-amount');
                const amount = amountInput.value;
                
                if (!amount || parseFloat(amount) <= 0) {
                    this.updateMessage("ERRO: Insira um valor de depósito válido e positivo.", true);
                    return;
                }

                try {
                    const value = ethers.utils.parseEther(amount);
                    
                    const tx = await this.contract.depositar({ value });
                    
                    this.updateMessage(`DEPÓSITO ENVIADO. Hash: ${this.formatAddress(tx.hash)}. Aguardando...`);
                    await tx.wait();
                    this.updateMessage(`DEPÓSITO de ${amount} ETH confirmado com sucesso!`);
                    amountInput.value = '';
                    
                    // Atualiza após depósito
                    setTimeout(() => {
                        this.loadContractData();
                    }, 1000); 

                } catch (error) {
                    console.error(error);
                    let reason = error.reason || error.message;
                    if (error.data && error.data.message) { reason = error.data.message; }
                    this.updateMessage(`ERRO DE DEPÓSITO: ${reason || "Falha na transação"}`, true);
                }
            }
            
            async transferir() {
                 if (!this.signer) {
                     this.updateMessage("ERRO: Conecte sua carteira primeiro.", true);
                     return;
                }
                
                const recipient = document.getElementById('transfer-recipient').value;
                const amount = document.getElementById('transfer-amount').value;
                
                if (!ethers.utils.isAddress(recipient)) {
                    this.updateMessage("ERRO: Endereço do Destinatário inválido.", true);
                    return;
                }
                if (!amount || parseFloat(amount) <= 0) {
                    this.updateMessage("ERRO: Insira um valor de saque válido e positivo.", true);
                    return;
                }
                
                try {
                    const valueInWei = ethers.utils.parseEther(amount);

                    const tx = await this.contract.transferirPara(recipient, valueInWei);
                    
                    this.updateMessage(`SAQUE ENVIADO. Hash: ${this.formatAddress(tx.hash)}. Aguardando...`);
                    await tx.wait();
                    this.updateMessage(`TRANSFERÊNCIA de ${amount} ETH para ${this.formatAddress(recipient)} concluída!`);
                    document.getElementById('transfer-recipient').value = '';
                    document.getElementById('transfer-amount').value = '';
                    
                    // Atualiza após transferência
                    setTimeout(() => {
                        this.loadContractData();
                    }, 1000); 

                } catch (error) {
                    console.error(error);
                    let reason = error.reason || error.message;
                    if (error.data && error.data.message) { reason = error.data.message; }
                    this.updateMessage(`ERRO DE TRANSFERÊNCIA: Verifique se você é o dono e se há saldo. Razão: ${reason}`, true);
                }
            }

            // ===================================
            // FUNÇÃO: SACAR TOTAL (CHAMA SACARTUDO) - OTIMIZADA A ATUALIZAÇÃO
            // ===================================
            async sacarTotal() {
                if (!this.signer) {
                    this.updateMessage("ERRO: Conecte sua carteira primeiro.", true);
                    return;
                }

                // Recarrega o saldo para uma checagem rápida antes da transação
                await this.loadContractData(); 

                const amountWei = this.contractBalanceWei;
                const amountETH = ethers.utils.formatEther(amountWei);

                if (amountWei.isZero()) {
                    this.updateMessage(`ERRO: O saldo do contrato é zero (${amountETH} ETH). Não há o que sacar.`, true);
                    return;
                }

                try {
                    // CHAMA A NOVA FUNÇÃO SACARTUDO()
                    const tx = await this.contract.sacarTudo({
                        gasLimit: 300000 
                    });
                    
                    this.updateMessage(`SAQUE TOTAL ENVIADO (${this.formatAddress(tx.hash)}). Aguardando confirmação...`);
                    
                    // Espera a confirmação da transação na rede
                    await tx.wait(); 
                    
                    this.updateMessage(`SAQUE TOTAL de ${amountETH} ETH concluído! Atualizando painel...`);
                    
                    // FORÇA A ATUALIZAÇÃO DO PAINEL APÓS UM PEQUENO ATRASO (2 SEGUNDOS)
                    setTimeout(() => {
                        this.loadContractData();
                    }, 2000); 

                } catch (error) {
                    console.error(error);
                    let reason = error.reason || error.message;
                    if (error.data && error.data.message) { reason = error.data.message; }

                    if (reason && reason.includes("Apenas o dono pode executar esta funcao")) {
                        reason = "Você não é o Dono do Contrato (onlyOwner falhou).";
                    } else if (reason && reason.includes("O contrato nao tem saldo para sacar")) {
                         reason = "O contrato está sem saldo, embora a leitura inicial possa ter sido atrasada.";
                    }
                    
                    this.updateMessage(`ERRO NO SAQUE TOTAL: Verifique permissões (onlyOwner) e saldo. Razão: ${reason}`, true);
                    
                    // Tentativa de recarregar mesmo em caso de erro (caso tenha havido um saque parcial)
                    setTimeout(() => {
                        this.loadContractData();
                    }, 1000);
                }
            }
            
            // ===================================
            // INICIALIZAÇÃO DO SISTEMA
            // ===================================
            
            initializeSystem() {
                if (typeof window.ethers === 'undefined') {
                    this.updateMessage("ERRO CRÍTICO: Biblioteca de blockchain não encontrada. Impossível operar.", true);
                    return; 
                }
                
                this.loadContractData();
                
                if (window.ethereum && window.ethereum.selectedAddress) {
                    this.conectarMetaMask();
                }
            }
        }

        // Inicializa a aplicação ao carregar o DOM
        document.addEventListener('DOMContentLoaded', () => {
            const app = new NetrunnerWallet();
            app.initializeSystem();
        });
    </script>
</body>
</html>